<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>당첨 확인 - 로또 6/45</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2064%2064'%3E%3Cdefs%3E%3CradialGradient%20id='g'%20cx='35%25'%20cy='30%25'%20r='80%25'%3E%3Cstop%20offset='0%25'%20stop-color='%232dd4bf'/%3E%3Cstop%20offset='55%25'%20stop-color='%237c5cff'/%3E%3Cstop%20offset='100%25'%20stop-color='%230b1220'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle%20cx='32'%20cy='32'%20r='28'%20fill='url(%23g)'/%3E%3Ccircle%20cx='32'%20cy='32'%20r='28'%20fill='none'%20stroke='rgba(234,240,255,0.25)'%20stroke-width='2'/%3E%3Ctext%20x='32'%20y='38'%20text-anchor='middle'%20font-family='system-ui,Segoe%20UI,Arial'%20font-size='18'%20font-weight='800'%20fill='%23eaf0ff'%3E6%2F45%3C/text%3E%3C/svg%3E" />
    <style>
        :root {
            --bg: #0b1220;
            --card: #0f1a2e;
            --text: #eaf0ff;
            --muted: #b8c3e6;
            --border: rgba(234, 240, 255, 0.16);
            --accent: #7c5cff;
            --accent-2: #2dd4bf;
        }

        body {
            margin: 0;
            padding: 24px;
            line-height: 1.6;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, sans-serif;
        }

        main {
            max-width: 860px;
            margin: 0 auto;
        }

        h1,
        h2 {
            margin: 0 0 8px 0;
        }

        .muted {
            color: var(--muted);
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin: 16px 0;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        select,
        button,
        textarea {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            font-family: inherit;
        }

        select {
            background: var(--card);
        }

        button {
            cursor: pointer;
            background: linear-gradient(135deg, rgba(124, 92, 255, 0.95), rgba(45, 212, 191, 0.9));
            border: 0;
            font-weight: 700;
        }

        button.btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border);
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tab-btn {
            background: transparent;
            border: 0;
            padding: 8px 16px;
            border-radius: 999px;
            cursor: pointer;
            color: var(--muted);
            font-weight: 600;
        }

        .tab-btn.active {
            background: rgba(124, 92, 255, 0.2);
            color: var(--text);
            font-weight: 800;
        }

        #myNumbersList {
            display: grid;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .history-item-chk {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
        }

        .result-ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 700;
            font-size: 14px;
            margin-right: 4px;
        }

        .ball-match {
            background: var(--accent);
            color: #fff;
        }

        .ball-bonus {
            background: var(--accent-2);
            color: #0b1220;
        }

        .rank-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            font-weight: 700;
            font-size: 12px;
        }

        .rank-1 {
            background: #fbbf24;
            color: #000;
        }

        .rank-2 {
            background: #94a3b8;
            color: #000;
        }

        .rank-3 {
            background: #b45309;
            color: #fff;
        }

        .rank-4 {
            background: #2dd4bf;
            color: #000;
        }

        .rank-5 {
            background: #7c5cff;
            color: #fff;
        }

        .result-row {
            display: grid;
            gap: 8px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
    </style>
</head>

<body>
    <main>
        <header style="margin-bottom: 24px;">
            <a href="/"
                style="text-decoration: none; color: inherit; display: inline-flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">←</span>
                <h1 style="margin: 0;">당첨 확인</h1>
            </a>
            <div class="muted">저장된 번호나 직접 입력한 번호로 당첨 결과를 확인해보세요.</div>
        </header>

        <section class="card">
            <div class="row" style="margin-bottom: 12px;">
                <label for="drawSelect" style="font-weight: 700;">회차 선택</label>
                <select id="drawSelect" style="flex: 1; max-width: 200px;">
                    <option>Loading...</option>
                </select>
                <div id="drawInfo" class="muted" style="flex: 1;"></div>
            </div>

            <div class="tab-nav">
                <button id="tabSaved" class="tab-btn active" type="button">저장된 번호</button>
                <button id="tabManual" class="tab-btn" type="button">직접 입력/붙여넣기</button>
            </div>

            <div id="panelSaved">
                <div style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="selectAllSaved" />
                        <span class="muted" style="font-size: 14px;">전체 선택</span>
                    </label>
                </div>
                <div id="myNumbersList">
                    <div class="muted">저장된 번호가 없습니다. (메인 화면에서 "저장하기"를 눌러주세요)</div>
                </div>
            </div>

            <div id="panelManual" style="display: none;">
                <div class="muted" style="margin-bottom: 8px; font-size: 14px;">
                    아래 형식 중 하나로 입력하세요:<br>
                    - 숫자 나열: 1 2 3 4 5 6<br>
                    - 여러 줄: 각 줄마다 숫자 6개<br>
                    - JSON: [[1,2,3,4,5,6], [7,8,9,10,11,12]]
                </div>
                <textarea id="manualInput" rows="6" style="width: 100%; box-sizing: border-box;"
                    placeholder="예: 1, 2, 3, 4, 5, 6"></textarea>
            </div>

            <div class="row" style="margin-top: 16px; justify-content: flex-end;">
                <button id="checkBtn" type="button" style="padding: 12px 24px; font-size: 16px;">결과 확인하기</button>
            </div>
        </section>

        <section id="resultSection" class="card" style="display: none;">
            <h2 style="margin-bottom: 12px;">확인 결과</h2>
            <div id="resultList"></div>
        </section>
    </main>

    <script>
        const STORAGE_KEY = 'lotto_history_v1';

        // UI Elements
        const drawSelect = document.getElementById('drawSelect');
        const drawInfo = document.getElementById('drawInfo');
        const tabSaved = document.getElementById('tabSaved');
        const tabManual = document.getElementById('tabManual');
        const panelSaved = document.getElementById('panelSaved');
        const panelManual = document.getElementById('panelManual');
        const myNumbersList = document.getElementById('myNumbersList');
        const selectAllSaved = document.getElementById('selectAllSaved');
        const checkBtn = document.getElementById('checkBtn');
        const resultSection = document.getElementById('resultSection');
        const resultList = document.getElementById('resultList');
        const manualInput = document.getElementById('manualInput');

        let allResults = []; // [{ draw_no, numbers: [], bonus_number }]
        let savedHistory = []; // from localStorage

        // Initialization
        (async function init() {
            loadSavedHistory();
            await fetchLottoResults();
            renderSavedHistory();
        })();

        function loadSavedHistory() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) savedHistory = JSON.parse(raw);
            } catch (e) {
                console.error(e);
            }
        }

        async function fetchLottoResults() {
            try {
                const res = await fetch('/api/lotto-results');
                const json = await res.json();
                if (json.success && Array.isArray(json.data)) {
                    // Sort descending by draw_no
                    allResults = json.data.sort((a, b) => b.draw_no - a.draw_no);
                    renderDrawSelect();
                }
            } catch (e) {
                drawInfo.textContent = '회차 정보를 불러오지 못했습니다.';
            }
        }

        function renderDrawSelect() {
            drawSelect.innerHTML = '';
            allResults.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.draw_no;
                opt.textContent = `${r.draw_no}회`;
                drawSelect.appendChild(opt);
            });
            if (allResults.length > 0) {
                updateDrawInfo();
            }
            drawSelect.addEventListener('change', updateDrawInfo);
        }

        function updateDrawInfo() {
            const drawNo = parseInt(drawSelect.value);
            const draw = allResults.find(r => r.draw_no === drawNo);
            if (draw) {
                drawInfo.innerHTML = `당첨번호: <b>${draw.numbers.join(', ')}</b> + 보너스 <b>${draw.bonus_number}</b>`;
            }
        }

        function renderSavedHistory() {
            myNumbersList.innerHTML = '';
            if (!savedHistory.length) {
                myNumbersList.innerHTML = '<div class="muted">저장된 번호가 없습니다.</div>';
                return;
            }
            savedHistory.forEach((item, idx) => {
                const div = document.createElement('label');
                div.className = 'history-item-chk';

                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.className = 'saved-item-checkbox';
                chk.value = idx;

                const info = document.createElement('span');
                info.innerHTML = `<b>#${idx + 1}</b> ${item.numbers.join(', ')}`;

                div.appendChild(chk);
                div.appendChild(info);
                myNumbersList.appendChild(div);
            });
        }

        // Tabs
        tabSaved.addEventListener('click', () => {
            tabSaved.className = 'tab-btn active';
            tabManual.className = 'tab-btn';
            panelSaved.style.display = 'block';
            panelManual.style.display = 'none';
        });

        tabManual.addEventListener('click', () => {
            tabSaved.className = 'tab-btn';
            tabManual.className = 'tab-btn active';
            panelSaved.style.display = 'none';
            panelManual.style.display = 'block';
        });

        // Select All
        selectAllSaved?.addEventListener('change', (e) => {
            const chks = document.querySelectorAll('.saved-item-checkbox');
            chks.forEach(c => c.checked = e.target.checked);
        });

        // Check Logic
        checkBtn.addEventListener('click', () => {
            const drawNo = parseInt(drawSelect.value);
            const targetDraw = allResults.find(r => r.draw_no === drawNo);
            if (!targetDraw) {
                alert('회차 정보를 선택해주세요.');
                return;
            }

            let setsToCheck = [];

            if (panelSaved.style.display !== 'none') {
                // Saved tab
                const chks = document.querySelectorAll('.saved-item-checkbox:checked');
                chks.forEach(c => {
                    const item = savedHistory[c.value];
                    if (item && item.numbers) setsToCheck.push({ src: 'Saved #' + (parseInt(c.value) + 1), nums: item.numbers });
                });
            } else {
                // Manual tab
                const text = manualInput.value.trim();
                if (!text) {
                    alert('번호를 입력해주세요.');
                    return;
                }
                // Try parsing JSON first
                try {
                    const parsed = JSON.parse(text);
                    if (Array.isArray(parsed)) {
                        if (parsed.length > 0 && Array.isArray(parsed[0])) {
                            // [[1,2,3...], ...]
                            parsed.forEach((row, i) => setsToCheck.push({ src: 'Manual #' + (i + 1), nums: row }));
                        } else {
                            // [1,2,3,4,5,6] (single)
                            setsToCheck.push({ src: 'Manual', nums: parsed });
                        }
                    }
                } catch {
                    // Fallback to text parsing
                    const lines = text.split('\n');
                    lines.forEach((line, i) => {
                        const nums = (line.match(/\d+/g) || []).map(n => parseInt(n));
                        if (nums.length >= 6) {
                            // Take first 6? or all? Let's take up to 6 unique if possible or just passed array
                            // Just filtering basic validity
                            setsToCheck.push({ src: 'Manual Line ' + (i + 1), nums: nums });
                        }
                    });
                }
            }

            if (setsToCheck.length === 0) {
                alert('검사할 번호가 없습니다.');
                return;
            }

            renderResults(targetDraw, setsToCheck);
        });

        function renderResults(target, sets) {
            resultSection.style.display = 'block';
            resultList.innerHTML = '';

            sets.forEach(set => {
                const myNums = set.nums;
                const winNums = new Set(target.numbers);
                const bonus = target.bonus_number;

                let matchCount = 0;
                let bonusMatch = false;

                const row = document.createElement('div');
                row.className = 'result-row';

                const header = document.createElement('div');
                header.style.fontWeight = 'bold';
                header.textContent = set.src;

                const ballsDiv = document.createElement('div');

                // Render balls
                myNums.forEach(n => {
                    const b = document.createElement('span');
                    b.className = 'result-ball';
                    b.textContent = n;

                    if (winNums.has(n)) {
                        b.classList.add('ball-match');
                        matchCount++;
                    } else if (n === bonus) {
                        b.classList.add('ball-bonus');
                        bonusMatch = true;
                    }
                    ballsDiv.appendChild(b);
                });

                // Determine Rank
                let rankText = '낙첨';
                let rankClass = '';
                if (matchCount === 6) { rankText = '1등'; rankClass = 'rank-1'; }
                else if (matchCount === 5 && bonusMatch) { rankText = '2등'; rankClass = 'rank-2'; }
                else if (matchCount === 5) { rankText = '3등'; rankClass = 'rank-3'; }
                else if (matchCount === 4) { rankText = '4등'; rankClass = 'rank-4'; }
                else if (matchCount === 3) { rankText = '5등'; rankClass = 'rank-5'; }

                const resultInfo = document.createElement('div');
                if (rankClass) {
                    resultInfo.innerHTML = `<span class="rank-badge ${rankClass}">${rankText}</span> (일치: ${matchCount}${bonusMatch ? '+보너스' : ''})`;
                } else {
                    resultInfo.textContent = `낙첨 (일치: ${matchCount})`;
                    resultInfo.className = 'muted';
                }

                row.appendChild(header);
                row.appendChild(ballsDiv);
                row.appendChild(resultInfo);
                resultList.appendChild(row);
            });

            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>